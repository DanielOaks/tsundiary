{% extends "base.html" %}

{% block content %}

<div class='post'>
    <div class='post_date'>today</div>
    <textarea id='edit_area' placeholder="{{ prompt }}" >{{ current_content }}</textarea>
    <div class='status_area'>
        <span id='char_count'>&nbsp;</span>
        <span id='save_status' style='float:right'><a href='/markdown'>M&darr; enabled</a></span>
    </div>
</div>

{% if old_posts %}
    {% for delta_name, p in old_posts %}
    <div class='post'>
    <div class='post_date'>
      <span title='{{ p.posted_date | prettydate }}'>{{ delta_name }}</span>
    </div>
    <div class='post_body'>{{ p.content | my_markdown | safe }}</div>
    </div>
    {% endfor %}
{% else %}
    <p>Once you have a history of old entries, I'll show them to you at certain intervals here...</p>
{% endif %}

<script>

var timer = null;
var textarea = $('#edit_area');
var old_content = textarea.val();
var cur_date = "{{ g.date.strftime('%Y%m%d') }}";

var CHAR_LIMIT = 10000;

function confess() {
    $('#save_status').html('saving...');
    content = textarea.val();
    $.post('/confess', { content: content, cur_date: cur_date },
        function (data) {
            $('#save_status').html(data);
        }
    );
};

function prime_update() {
    $('#save_status').html('writing...')
    timer = setTimeout(function() {
        $('#save_status').html('saving...')
        confess();
    }, 500);
}

function update_char_count() {
    count = unescape(encodeURIComponent(textarea.val())).length;
    $('#char_count').html(count + '/' + CHAR_LIMIT);

    // Scale textarea
    textarea.css("height", Math.max(textarea[0].scrollHeight, 80) + "px");

    return count;
}

function content_changed() {
    var count = update_char_count();
    clearTimeout(timer);

    if (count <= CHAR_LIMIT) {
        // Just right.
        $('#char_count').removeClass('error');
        old_content = textarea.val();
    }
    else {
        //$('#char_count').addClass('error');
        //$('#save_status').html('too long');
        textarea.val(old_content);
        update_char_count();
    }
    prime_update();
};

textarea.bind('input propertychange', content_changed);
$( document ).ready(function () {
    update_char_count();
    // This is an ugly fix.
    setTimeout(update_char_count, 100);
});

</script>

{% endblock %}
